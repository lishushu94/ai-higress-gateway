<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PWA è°ƒè¯•å·¥å…·</title>
  <style>
    body { font-family: system-ui; padding: 20px; max-width: 800px; margin: 0 auto; }
    .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .info { background: #d1ecf1; color: #0c5460; }
    button { padding: 10px 20px; margin: 5px; cursor: pointer; }
    pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
  </style>
</head>
<body>
  <h1>ğŸ” PWA å®‰è£…æ¡ä»¶æ£€æŸ¥</h1>
  <div id="results"></div>
  <button onclick="checkPWA()">é‡æ–°æ£€æŸ¥</button>
  <button onclick="installPWA()">æ‰‹åŠ¨è§¦å‘å®‰è£…</button>

  <script>
    let deferredPrompt;
    const results = document.getElementById('results');

    // ç›‘å¬å®‰è£…æç¤ºäº‹ä»¶
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      addResult('âœ… PWA å¯ä»¥å®‰è£…ï¼beforeinstallprompt äº‹ä»¶å·²è§¦å‘', 'success');
      console.log('beforeinstallprompt event fired', e);
    });

    // ç›‘å¬å®‰è£…å®Œæˆ
    window.addEventListener('appinstalled', () => {
      addResult('âœ… PWA å·²æˆåŠŸå®‰è£…', 'success');
      deferredPrompt = null;
    });

    function addResult(message, type = 'info') {
      const div = document.createElement('div');
      div.className = `status ${type}`;
      div.textContent = message;
      results.appendChild(div);
    }

    async function checkPWA() {
      results.innerHTML = '<h2>æ£€æŸ¥ç»“æœï¼š</h2>';

      // 1. æ£€æŸ¥ HTTPS
      const isSecure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
      addResult(`1. å®‰å…¨è¿æ¥: ${isSecure ? 'âœ…' : 'âŒ'} (${location.protocol}//${location.host})`, isSecure ? 'success' : 'error');

      // 2. æ£€æŸ¥ Service Worker
      if ('serviceWorker' in navigator) {
        addResult('2. Service Worker API: âœ… æ”¯æŒ', 'success');
        try {
          const registration = await navigator.serviceWorker.getRegistration();
          if (registration) {
            addResult(`   - å·²æ³¨å†Œ: âœ… scope=${registration.scope}`, 'success');
            addResult(`   - çŠ¶æ€: ${registration.active ? 'âœ… active' : 'âš ï¸ ' + (registration.installing ? 'installing' : 'waiting')}`, registration.active ? 'success' : 'info');
          } else {
            addResult('   - âŒ æœªæ‰¾åˆ°æ³¨å†Œçš„ Service Worker', 'error');
          }
        } catch (err) {
          addResult(`   - âŒ æ£€æŸ¥å¤±è´¥: ${err.message}`, 'error');
        }
      } else {
        addResult('2. Service Worker API: âŒ ä¸æ”¯æŒ', 'error');
      }

      // 3. æ£€æŸ¥ manifest
      try {
        const manifestLink = document.querySelector('link[rel="manifest"]');
        if (manifestLink) {
          addResult(`3. Manifest é“¾æ¥: âœ… ${manifestLink.href}`, 'success');
          
          const response = await fetch(manifestLink.href);
          const manifest = await response.json();
          addResult(`   - name: ${manifest.name || 'âŒ ç¼ºå¤±'}`, manifest.name ? 'success' : 'error');
          addResult(`   - short_name: ${manifest.short_name || 'âš ï¸ ç¼ºå¤±'}`, manifest.short_name ? 'success' : 'info');
          addResult(`   - start_url: ${manifest.start_url || 'âŒ ç¼ºå¤±'}`, manifest.start_url ? 'success' : 'error');
          addResult(`   - display: ${manifest.display || 'âŒ ç¼ºå¤±'}`, manifest.display ? 'success' : 'error');
          addResult(`   - icons: ${manifest.icons?.length || 0} ä¸ª`, manifest.icons?.length >= 2 ? 'success' : 'error');
          
          if (manifest.icons) {
            manifest.icons.forEach(icon => {
              addResult(`     â€¢ ${icon.sizes} - ${icon.src}`, 'info');
            });
          }

          // æ˜¾ç¤ºå®Œæ•´ manifest
          const pre = document.createElement('pre');
          pre.textContent = JSON.stringify(manifest, null, 2);
          results.appendChild(pre);
        } else {
          addResult('3. Manifest é“¾æ¥: âŒ æœªæ‰¾åˆ°', 'error');
        }
      } catch (err) {
        addResult(`3. Manifest æ£€æŸ¥å¤±è´¥: âŒ ${err.message}`, 'error');
      }

      // 4. æ£€æŸ¥å®‰è£…æç¤º
      if (deferredPrompt) {
        addResult('4. å®‰è£…æç¤º: âœ… å·²æ•è· beforeinstallprompt', 'success');
      } else {
        addResult('4. å®‰è£…æç¤º: âŒ æœªæ•è· beforeinstallpromptï¼ˆå¯èƒ½å·²å®‰è£…æˆ–ä¸æ»¡è¶³æ¡ä»¶ï¼‰', 'error');
      }

      // 5. æ£€æŸ¥æ˜¯å¦å·²å®‰è£…
      if (window.matchMedia('(display-mode: standalone)').matches) {
        addResult('5. è¿è¡Œæ¨¡å¼: âœ… å·²ä½œä¸º PWA è¿è¡Œ', 'success');
      } else {
        addResult('5. è¿è¡Œæ¨¡å¼: âš ï¸ åœ¨æµè§ˆå™¨ä¸­è¿è¡Œ', 'info');
      }

      // 6. æµè§ˆå™¨ä¿¡æ¯
      addResult(`6. æµè§ˆå™¨: ${navigator.userAgent}`, 'info');
    }

    async function installPWA() {
      if (!deferredPrompt) {
        addResult('âŒ æ— æ³•å®‰è£…ï¼šæœªæ•è·åˆ° beforeinstallprompt äº‹ä»¶', 'error');
        addResult('å¯èƒ½åŸå› ï¼š1) å·²å®‰è£… 2) ä¸æ»¡è¶³å®‰è£…æ¡ä»¶ 3) æµè§ˆå™¨ä¸æ”¯æŒ', 'info');
        return;
      }

      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      addResult(`ç”¨æˆ·é€‰æ‹©: ${outcome}`, outcome === 'accepted' ? 'success' : 'info');
      deferredPrompt = null;
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
    window.addEventListener('load', checkPWA);
  </script>
</body>
</html>
