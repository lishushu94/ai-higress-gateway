# AI Higress Gateway 环境变量示例
#
# 使用方式：
# 1. 复制本文件为 .env
# 2. 按需修改下方密码/密钥/回调地址
# 3. 运行开发镜像（推荐新手）：
#    IMAGE_TAG=latest docker compose -f docker-compose.develop.yml --env-file .env up -d
# 4. 生产部署：
#    IMAGE_TAG=latest docker compose -f docker-compose-deploy.yml --env-file .env up -d
#
# 说明：
# - 本示例默认面向 Docker 镜像/Compose 场景，因此 DATABASE_URL / REDIS_URL 使用容器内服务名
#   （postgres/redis），不要写本机回环地址。
# - 如果你选择“本地运行后端 + Docker 起数据库/Redis”，请参考各段落中的本机地址示例改写 URL。

# 运行环境与日志
APP_ENV=development


# CORS 配置（多个来源用英文逗号分隔）
# 前端在容器外访问时通常为 http(s)://你的域名 或 http://你的IP:3000
# 本地前端默认可用：http://127.0.0.1:3000
CORS_ALLOW_ORIGINS=http://your-frontend-domain-or-ip:3000
CORS_ALLOW_CREDENTIALS=true
CORS_ALLOW_METHODS=*
CORS_ALLOW_HEADERS=*

# 初始管理员（可自定义，首次启动自动创建）
DEFAULT_ADMIN_USERNAME=admin
DEFAULT_ADMIN_EMAIL=admin@example.com

# PostgreSQL 配置
POSTGRES_USER=apiproxy
# 必填：请设置强密码（Docker Compose 配置要求不能为空）
POSTGRES_PASSWORD=
POSTGRES_DB=apiproxy

# Docker 镜像模式（推荐）：后端容器通过 service 名访问数据库
DATABASE_URL=postgresql+psycopg://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}  # pragma: allowlist secret
# 本地运行后端（非容器）时可改为（compose 暴露端口默认 15432）：
# DATABASE_URL=postgresql+psycopg://${POSTGRES_USER}:${POSTGRES_PASSWORD}@127.0.0.1:15432/${POSTGRES_DB}  # pragma: allowlist secret

# Redis 配置
# 必填：请设置强密码（Docker Compose 配置要求不能为空）
REDIS_PASSWORD=
# Docker 镜像模式（推荐）
REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/0
# 本地运行后端（非容器）时可改为（compose 暴露端口默认 16379）：
# REDIS_URL=redis://:${REDIS_PASSWORD}@127.0.0.1:16379/0

# Celery 配置（默认复用同一 Redis）
CELERY_BROKER_URL=${REDIS_URL}
CELERY_RESULT_BACKEND=${REDIS_URL}

# 积分/计费
# 是否在网关层强制校验用户积分余额（不足时返回 402）
ENABLE_CREDIT_CHECK=false
# 流式请求是否在开始前做预估扣费（默认关闭）
ENABLE_STREAMING_PRECHARGE=false
# 流式请求在无法获取 usage 时用于预估扣费的最小 token 数
STREAMING_MIN_TOKENS=500
# 会话模式下构建上游 messages 时最多携带的历史消息条数（不含 system；不含本次新 user 消息）。0 表示不限制。
CHAT_CONTEXT_MAX_MESSAGES=50

# 安全中间件开关：true 强制开启，false 强制关闭
# 默认行为：APP_ENV=production 时开启；非生产环境关闭
ENABLE_SECURITY_MIDDLEWARE=true
# ENABLE_SECURITY_MIDDLEWARE=false

# API 文档路由开关：true 强制开启，false 强制关闭
# 默认行为：APP_ENV=production 时关闭 /docs、/redoc、/openapi.json；非生产环境开启
ENABLE_API_DOCS=

# 应用密钥（用于 JWT/HMAC/加密等敏感标识）
# 请使用系统 API POST /system/secret-key/generate 生成随机值并替换
SECRET_KEY=

# Bridge / MCP Tunnel Gateway（可选）
# 后端 -> Gateway 内网调用地址（Docker Compose 下建议使用服务名）
BRIDGE_GATEWAY_URL=http://bridge_gateway:8088
# 保护 Gateway 内网接口 /internal/bridge/* 的共享 Token（强烈建议设置；否则对公网暴露 8088 时会有风险）
BRIDGE_GATEWAY_INTERNAL_TOKEN=

# LinuxDo OAuth2（可选，启用后可使用 LinuxDo 登录）
LINUXDO_OAUTH_ENABLED=false
LINUXDO_CLIENT_ID=
LINUXDO_CLIENT_SECRET=
# 回调地址必须是你实际可访问的域名（不要使用本机回环地址），例如：https://ai.example.com/callback
LINUXDO_REDIRECT_URI=https://your-domain.com/callback

# Provider 健康检查与路由过滤
# 是否启用 Provider 健康状态检查和路由过滤（关闭后将忽略 Provider 状态和最低分数过滤）
ENABLE_PROVIDER_HEALTH_CHECK=true

# Provider 实时故障标记（用于快速跳过故障 Provider）
# 故障冷却期（秒）：在此期间内失败次数超过阈值的 Provider 将被跳过
PROVIDER_FAILURE_COOLDOWN_SECONDS=60
# 故障阈值：在冷却期内失败次数超过此值将被跳过
PROVIDER_FAILURE_THRESHOLD=3

# 上游请求代理池
# 已改为“后台管理式代理池”（DB 配置 + Celery 测活 + Redis 可用集合），不再通过环境变量配置代理列表。
# 仍可通过环境变量控制“同一次上游请求内，代理连接失败时的换代理重试次数”（0 表示不重试）。
UPSTREAM_PROXY_MAX_RETRIES=1

LOG_LEVEL=INFO
# LOG_TIMEZONE=Asia/Shanghai
# 日志输出目录（相对路径以 backend 项目根目录为基准）
LOG_DIR=logs
# 保留最近 N 天的日志目录；0 表示不清理
LOG_BACKUP_DAYS=7
# 是否按业务拆分日志文件（拆分后目录结构示例：logs/2025-12-12/chat.log）
LOG_SPLIT_BY_BUSINESS=true

# Next.js 环境变量示例

# API 地址（用于前端访问后端 API，也用于 CLI 配置脚本生成）
NEXT_PUBLIC_API_BASE_URL=http://localhost:8000

# 后端 API 基础 URL（用于 CLI 配置脚本中的 api_url 字段）
# 生产环境请设置为实际的域名，例如: https://your-domain.com
# 这个 URL 会被写入到 Claude Code CLI 和 Codex CLI 的配置文件中
API_BASE_URL=http://localhost:8000

# 分析开关
ANALYZE=false

# 类型检查开关
SKIP_TYPE_CHECK=false
